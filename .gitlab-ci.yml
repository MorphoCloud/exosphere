image: node:current-buster

stages:
#  - dockerize
  - confidence-check
  - build
  - test
  - deploy

cache:
  key: ${CI_JOB_NAME}
  paths:
    - node_modules/
    - home/.elm
    - home/.npm
    - elm-stuff/

#build_with_kaniko:
#  stage: dockerize
#  image:
#    name: gcr.io/kaniko-project/executor:debug
#    entrypoint: [ "" ]
#  script:
#    - mkdir -p /kaniko/.docker
#    - env
#    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(echo -n $CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD | base64)\"}}}" > /kaniko/.docker/config.json
#    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination $CI_REGISTRY_IMAGE:latest


elm_make:
  stage: build
  before_script:
    # https://gitlab.com/gitlab-org/gitlab-runner/-/issues/327#note_225643576
    - if [ -d home/.elm ]; then echo "Restoring ~/.elm"; mv home/.elm ~/; fi
    - if [ -d home/.npm ]; then echo "Restoring ~/.npm"; mv home/.npm ~/; fi
    - npm install elm@0.19.1-3
  script:
    - npx elm make src/Exosphere.elm --output public/elm-web.js
    - npx elm make src/ExosphereElectron.elm --output public/elm.js
    - cp index.html public/index.html
    - cp ports.js public/ports.js
    - cp -R assets public
    - cp -R fonts public
  after_script:
    - mkdir -p home && mv ~/.elm home
    - mkdir -p home && mv ~/.npm home
  artifacts:
    paths:
      - public

elm_analyse:
  stage: test
  before_script:
    - if [ -d home/.elm ]; then echo "Restoring ~/.elm"; mv home/.elm ~/; fi
    - if [ -d home/.npm ]; then echo "Restoring ~/.npm"; mv home/.npm ~/; fi
    - npm install elm@0.19.1-3 elm-analyse elm-format
  script:
    - npx elm-analyse
    - npx elm-format --validate src
  after_script:
    - mkdir -p home && mv ~/.elm home
    - mkdir -p home && mv ~/.npm home

elm_test:
  stage: test
  before_script:
    - if [ -d home/.elm ]; then echo "Restoring ~/.elm"; mv home/.elm ~/; fi
    - if [ -d home/.npm ]; then echo "Restoring ~/.npm"; mv home/.npm ~/; fi
    - npm install elm@0.19.1-3 elm-test@0.19.1
  script:
    - npx elm-test
  after_script:
    - mkdir -p home && mv ~/.elm home
    - mkdir -p home && mv ~/.npm home

pages:
  stage: deploy
  dependencies:
    - elm_make
  script:
    - touch public/index.html
  artifacts:
    paths:
      - public
  only:
    - master

deploy_prod:
  stage: deploy
  dependencies:
    - elm_make
  before_script:
    # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$DOGFOOD_SSH_PRIV_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # https://docs.gitlab.com/ee/ci/ssh_keys/README.html#verifying-the-ssh-host-keys
    - echo "$DOGFOOD_SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - 'which rsync || ( apt-get update -y && apt-get install rsync -y )'
  script:
    - 'cp environment-configs/try.exosphere.app-config.js public/config.js'
    - 'sed -i -e ''s/<base href="\/">/<base href="\/exosphere\/">/g'' public/index.html'
    - 'rsync -av --delete public exouser@dogfood.exosphere.app:'
  environment:
    name: prod
    url: https://try.exosphere.app/exosphere
  only:
    - master

deploy_jetstream:
  stage: deploy
  dependencies:
    - elm_make
  before_script:
    # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$DOGFOOD_SSH_PRIV_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # https://docs.gitlab.com/ee/ci/ssh_keys/README.html#verifying-the-ssh-host-keys
    - echo "$DOGFOOD_SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - 'which rsync || ( apt-get update -y && apt-get install rsync -y )'
  script:
    - 'cp environment-configs/exosphere.jetstream-cloud.org-config.js public/config.js'
    - 'sed -i -e ''s/<base href="\/">/<base href="\/exosphere\/">/g'' public/index.html'
    - 'rsync -av --delete public exouser@dogfood.exosphere.app:jetstream-deploy/'
  environment:
    name: jetstream
    url: https://exosphere.jetstream-cloud.org/exosphere
  only:
    - master


deploy_dev:
  stage: deploy
  needs:
    - elm_make
  before_script:
    # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$DOGFOOD_SSH_PRIV_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # https://docs.gitlab.com/ee/ci/ssh_keys/README.html#verifying-the-ssh-host-keys
    - echo "$DOGFOOD_SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - 'which rsync || ( apt-get update -y && apt-get install rsync -y )'
  script:
    - 'cp environment-configs/try-dev.exosphere.app-config.js public/config.js'
    - 'sed -i -e ''s/<base href="\/">/<base href="\/exosphere\/">/g'' public/index.html'
    - 'rsync -av --delete public exouser@dogfood.exosphere.app:dev-deploy/'
  environment:
    name: dev
    url: https://try-dev.exosphere.app/exosphere
  only:
    - dev


e2e:firefox:
  stage: confidence-check
  image: python:3
  allow_failure: false
#  retry: 2
  services:
    - name: "$CI_REGISTRY_IMAGE:latest"
      alias: confidence-check.exosphere.localhost
      entrypoint: ["/bin/sh", "-c"]
      command: ["env && cd /usr/src/app && ls -al && npx elm-live src/Exosphere.elm --host 0.0.0.0 --pushstate true --verbose --start-page index.html --hot true -- --output=elm-web.js"]
    - name: selenium/standalone-firefox
      entrypoint: ["/bin/sh", "-c"]
      command: ["env && cat /etc/hosts && echo '172.17.0.3 confidence-check.exosphere.localhost' >> /etc/hosts && cat /etc/hosts && /opt/bin/entry_point.sh"]
  before_script:
    - pip install -r integration-tests/requirements.txt
  script:
    - ls -alt
    - cd integration-tests
    - cat /etc/hosts
    - ping -c 1 confidence-check.exosphere.localhost
    - curl --dump-header - http://confidence-check.exosphere.localhost:8000
    - behave -D EXOSPHERE_BASE_URL=http://confidence-check.exosphere.localhost:8000 -D REMOTE_WEBDRIVER=yes -D COMMAND_EXECUTOR=http://selenium__standalone-firefox:4444/wd/hub features/exosphere.feature


include:
  - template: Dependency-Scanning.gitlab-ci.yml
